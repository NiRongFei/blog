---
title: jQuery方法的源生实现
date: 2017-04-19
tags:
  - frontend
  - jquery
categories:
  - 前端
---

随着 React、Angular、Vue 等前端框架的流行，直接操作 DOM 的方式逐渐被抛弃，jQuery 的使用场景大大减少。这里总结了部分 jQuery API 对应的源生是实现方式，暂时只支持 IE10 以上浏览器。

## Query Selector

常用的 id、class、属性 选择器都可以使用 document.querySelector 或 document.querySelectorAll 替代。区别是

- document.querySelector 返回第一个匹配的 Node
- document.querySelectorAll 返回所有匹配的 NodeList，通过 [].slice.call() 可以把它转成 Array
- 如果匹配不到任何 Node，jQuery 返回空数组 []，但 document.querySelector 返回 null，注意空指针异常。当找不到时，也可以使用 || 设置默认的值，如 document.querySelectorAll(selector) || []

> 注意：document.querySelector 和 document.querySelectorAll 性能很差。如果想提高性能，尽量使用 document.getElementById、document.getElementsByClassName 或 document.getElementsByTagName。

1. 标签选择器

```js
// jQuery
$('selector')
// Native
document.querySelectorAll('selector')
```

2. id 选择器

```js
// jQuery
$('#id')
// Native
document.querySelector('#id')
document.getElementById('id')
```

3. class 选择器

```js
// jQuery
$('.class')
// Native
document.querySelectorAll('.class')
document.getElementsByClassName('class')
```

4. 属性选择器

````js
// jQuery
$('a[target=_blank]');
// Native
document.querySelectorAll('a[target=_blank]');
···
5. 后代选择器
```js
// jQuery
$el.find('li');
// Native
el.querySelectorAll('li');
````

6. 兄弟选择器

- 兄弟元素

```js
// jQuery
$el.siblings()
// Native - latest, Edge13+
;[...el.parentNode.children].filter(child => child !== el)
// Native (alternative) - latest, Edge13+
Array.from(el.parentNode.children).filter(child => child !== el)
// Native - IE10+
Array.prototype.filter.call(el.parentNode.children, child => child !== el)
```

- 上一个元素

```js
// jQuery
$el.prev()
// Native
el.previousElementSibling
```

- 下一个元素

```js
// next
$el.next()
// Native
el.nextElementSibling
```

7. Closest

Closest 获得匹配选择器的第一个祖先元素，从当前元素开始沿 DOM 树向上。

```js
// jQuery
$el.closest(queryString)
// Native - Only latest, NO IE
el.closest(selector)
// Native - IE10+
function closest(el, selector) {
  const matchesSelector = el.matches || el.webkitMatchesSelector || el.mozMatchesSelector || el.msMatchesSelector

  while (el) {
    if (matchesSelector.call(el, selector)) {
      return el
    } else {
      el = el.parentElement
    }
  }
  return null
}
```

8. Parents Until

获取当前每一个匹配元素集的祖先，不包括匹配元素的本身。

```js
// jQuery
$el.parentsUntil(selector, filter)
// Native
function parentsUntil(el, selector, filter) {
  const result = []
  const matchesSelector = el.matches || el.webkitMatchesSelector || el.mozMatchesSelector || el.msMatchesSelector

  // match start from parent
  el = el.parentElement
  while (el && !matchesSelector.call(el, selector)) {
    if (!filter) {
      result.push(el)
    } else {
      if (matchesSelector.call(el, filter)) {
        result.push(el)
      }
    }
    el = el.parentElement
  }
  return result
}
```

9. Form

Input/Textarea

```js
// jQuery
$('#my-input').val()
// Native
document.querySelector('#my-input').value
```

获取 `e.currentTarget` 在 `.radio` 中的数组索引

```js
// jQuery
$('.radio').index(e.currentTarget)
// Native
Array.prototype.indexOf.call(document.querySelectorAll('.radio'), e.currentTarget)
```

10. Iframe Contents

jQuery 对象的 `iframe contents()` 返回的是 `iframe` 内的 `document`

- Iframe contents

```js
// jQuery
$iframe.contents()
// Native
iframe.contentDocument
```

- Iframe Query

```js
// jQuery
$iframe.contents().find('.css')
// Native
iframe.contentDocument.querySelectorAll('.css')
```

11. 获取 body

```js
// jQuery
$('body')
// Native
document.body
```

12. 获取或设置属性

- 获取属性

```js
// jQuery
$el.attr('foo')
// Native
el.getAttribute('foo')
```

- 设置属性

```js
// jQuery, note that this works in memory without change the DOM
$el.attr('foo', 'bar')
// Native
el.setAttribute('foo', 'bar')
```

- 获取 `data-` 属性

```js
// jQuery
$el.data('foo')
// Native (use `getAttribute`)
el.getAttribute('data-foo')
// Native (use `dataset` if only need to support IE 11+)
el.dataset['foo']
```
